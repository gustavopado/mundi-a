<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jogo de Carro 3D Melhorado</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #222;
            color: #eee;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
        }
        #info {
            position: absolute;
            top: 10px;
            z-index: 10;
            width: 100%;
            text-align: center;
            pointer-events: none;
            user-select: none;
            font-size: 1.5em;
            font-weight: bold;
            color: #0f0;
        }
        #endGameMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            color: white;
            display: none;
            z-index: 20;
        }
        #restartButton, #hornButton {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #restartButton:hover, #hornButton:hover {
            background-color: #0056b3;
        }
        #hornButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 15;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <div id="info">Pontua√ß√£o: <span id="score">0</span></div>
    <div id="endGameMessage">
        <h2>Fim de Jogo!</h2>
        <p>Sua pontua√ß√£o: <span id="finalScore">0</span></p>
        <button id="restartButton">Reiniciar Jogo</button>
    </div>

    <!-- Bot√£o de buzina -->
    <button id="hornButton">üöó Buzinar</button>
    <!-- √Åudio da buzina (coloque o arquivo buzina.mp3 na mesma pasta que este HTML) -->
    <audio id="hornSound" src="buzina.mp3" preload="auto"></audio>
    <audio id="engineSound" src="motor.mp3" preload="auto" loop></audio>

    <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
    <script>
        // ================== SETUP B√ÅSICO ==================
        const scene = new THREE.Scene();
        let currentTheme = 0;
        const themes = [
            { roadColor: 0x333333, skyColor: 0x87ceeb, ambientIntensity: 0.7, directionalColor: 0xffffff, directionalIntensity: 0.8 },
            { roadColor: 0x222222, skyColor: 0xffa500, ambientIntensity: 0.5, directionalColor: 0xffaa00, directionalIntensity: 0.6 },
            { roadColor: 0x444444, skyColor: 0x001844, ambientIntensity: 0.3, directionalColor: 0x6666ff, directionalIntensity: 0.5 },
            { roadColor: 0x1a3d1a, skyColor: 0xaaffaa, ambientIntensity: 0.6, directionalColor: 0x44bb44, directionalIntensity: 0.7 }
        ];

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 30);
        camera.lookAt(0,0,0);

        const renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Luzes
        let ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        let directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 20, 10);
        scene.add(directionalLight);

        // Estrada
        let roadGeometry = new THREE.PlaneGeometry(20, 200);
        let roadMaterial = new THREE.MeshStandardMaterial({color: 0x333333});
        let road = new THREE.Mesh(roadGeometry, roadMaterial);
        road.rotation.x = -Math.PI / 2;
        road.position.z = -10;
        scene.add(road);

        // Linhas da estrada
        const lineMaterial = new THREE.MeshStandardMaterial({color: 0xffff00});
        const lines = [];
        for(let i=0; i<20; i++) {
            const lineGeo = new THREE.BoxGeometry(1, 0.05, 9);
            const line = new THREE.Mesh(lineGeo, lineMaterial);
            line.position.set(0, 0.01, i*1 - 10);
            scene.add(line);
            lines.push(line);
        }

        function createCar(color) {
            const car = new THREE.Group();
            const baseGeo = new THREE.BoxGeometry(3, 1, 5);
            const baseMat = new THREE.MeshStandardMaterial({color});
            const base = new THREE.Mesh(baseGeo, baseMat);
            base.position.y = 0.5;
            car.add(base);
            const hoodGeo = new THREE.BoxGeometry(3, 0.7, 2);
            const hoodMat = new THREE.MeshStandardMaterial({color: 0x222222});
            const hood = new THREE.Mesh(hoodGeo, hoodMat);
            hood.position.set(0, 1.0, 1.5);
            car.add(hood);
            const roofGeo = new THREE.BoxGeometry(2, 0.5, 3);
            const roofMat = new THREE.MeshStandardMaterial({color: 0x555555});
            const roof = new THREE.Mesh(roofGeo, roofMat);
            roof.position.set(0, 1.3, -0.3);
            car.add(roof);
            const wheelGeo = new THREE.CylinderGeometry(0.5, 0.5, 0.3, 16);
            const wheelMat = new THREE.MeshStandardMaterial({color: 0x222222});
            for(let i = -1; i <=1; i+=2) {
                for(let j = -1; j <=1; j+=2) {
                    const wheel = new THREE.Mesh(wheelGeo, wheelMat);
                    wheel.rotation.z = Math.PI/2;
                    wheel.position.set(i*1.2, 0.3, j*1.8);
                    car.add(wheel);
                }
            }
            return car;
        }

        function createTree() {
            const tree = new THREE.Group();
            const trunkGeo = new THREE.CylinderGeometry(0.3, 0.3, 2);
            const trunkMat = new THREE.MeshStandardMaterial({color: 0x8B4513});
            const trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.position.y = 1;
            tree.add(trunk);
            const leavesGeo = new THREE.ConeGeometry(1.5, 4, 8);
            const leavesMat = new THREE.MeshStandardMaterial({color: 0x228B22});
            const leaves = new THREE.Mesh(leavesGeo, leavesMat);
            leaves.position.y = 3.5;
            tree.add(leaves);
            return tree;
        }

        const playerCar = createCar(0x0000ff);
        playerCar.position.z = 20;
        scene.add(playerCar);

        const enemies = [];
        const trees = [];
        for(let i=0; i<10; i++) {
            let treeL = createTree();
            treeL.position.set(-12, 0, i*10 - 50);
            scene.add(treeL);
            trees.push(treeL);
            let treeR = createTree();
            treeR.position.set(12, 0, i*10 - 50);
            scene.add(treeR);
            trees.push(treeR);
        }

        let score = 0;
        let gameOver = false;
        const speed = 0.5;
        const laneWidth = 7;
        const maxX = laneWidth;
        const keys = {};
        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);

        function spawnEnemy() {
            if (gameOver) return;
            const enemy = createCar(0xff0000);
            enemy.position.z = -50;
            const lanes = [-laneWidth, 0, laneWidth];
            enemy.position.x = lanes[Math.floor(Math.random()*lanes.length)];
            scene.add(enemy);
            enemies.push(enemy);
        }

        spawnEnemy();
        let spawnInterval = setInterval(spawnEnemy, 1500);

        function updateRoadLines() {
            lines.forEach(line => {
                line.position.z += speed*10;
                if(line.position.z > 30) line.position.z = -70;
            });
        }
        function updateTrees() {
            trees.forEach(tree => {
                tree.position.z += speed;
                if(tree.position.z > 20) tree.position.z -= 120;
            });
        }
        function checkCollision(obj1, obj2) {
            const box1 = new THREE.Box3().setFromObject(obj1);
            const box2 = new THREE.Box3().setFromObject(obj2);
            return box1.intersectsBox(box2);
        }
        function updateTheme() {
            let phase = Math.floor(score / 15) % themes.length;
            if (phase !== currentTheme) {
                currentTheme = phase;
                const theme = themes[phase];
                road.material.color.setHex(theme.roadColor);
                scene.background = new THREE.Color(theme.skyColor);
                ambientLight.color.setHex(theme.directionalColor);
                ambientLight.intensity = theme.ambientIntensity;
                directionalLight.color.setHex(theme.directionalColor);
                directionalLight.intensity = theme.directionalIntensity;
            }
        }

        const scoreDisplay = document.getElementById('score');
        const endGameMessage = document.getElementById('endGameMessage');
        const finalScoreDisplay = document.getElementById('finalScore');
        const restartButton = document.getElementById('restartButton');

        restartButton.addEventListener('click', () => {
            gameOver = false;
            score = 0;
            scoreDisplay.textContent = score;
            playerCar.position.x = 0;
            enemies.forEach(e => scene.remove(e));
            enemies.length = 0;
            endGameMessage.style.display = 'none';
            spawnInterval = setInterval(spawnEnemy, 1500);
            animate();
        });

        function animate() {
            if (gameOver) return;
            requestAnimationFrame(animate);
            if(keys['ArrowLeft'] && playerCar.position.x > -maxX) playerCar.position.x -= 0.3;
            if(keys['ArrowRight'] && playerCar.position.x < maxX) playerCar.position.x += 0.3;
            for(let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                enemy.position.z += speed;
                if(enemy.position.z > 30) {
                    scene.remove(enemy);
                    enemies.splice(i,1);
                    score++;
                    scoreDisplay.textContent = score;
                    updateTheme();
                }
                if(checkCollision(playerCar, enemy)) {
                    gameOver = true;
                    finalScoreDisplay.textContent = score;
                    endGameMessage.style.display = 'block';
                    clearInterval(spawnInterval);
                }
            }
            updateRoadLines();
            updateTrees();
            renderer.render(scene, camera);
        }

        scene.background = new THREE.Color(themes[0].skyColor);
        ambientLight.color.setHex(themes[0].directionalColor);
        ambientLight.intensity = themes[0].ambientIntensity;
        directionalLight.color.setHex(themes[0].directionalColor);
        directionalLight.intensity = themes[0].directionalIntensity;
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ======= BUZINA =======
        function tocarBuzina() {
            const hornSound = document.getElementById("hornSound");
            hornSound.currentTime = 0;
            hornSound.play();
        }
        document.getElementById("hornButton").addEventListener("click", tocarBuzina);
        window.addEventListener("keydown", (e) => {
            if (e.key.toLowerCase() === "b") tocarBuzina();
        });
    </script>
</body>
</html>